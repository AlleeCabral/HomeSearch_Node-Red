[
    {
        "id": "d0aa877c69268acf",
        "type": "tab",
        "label": "Flow 1",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "3573323ad1e8e91d",
        "type": "tab",
        "label": "Flow 2",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "8de2ee7b9a7ab0c8",
        "type": "telegram bot",
        "botname": "mudanssa_bot",
        "usernames": "",
        "chatids": "-1002546713175,672048596",
        "baseapiurl": "",
        "testenvironment": false,
        "updatemode": "polling",
        "pollinterval": "300",
        "usesocks": false,
        "sockshost": "",
        "socksprotocol": "socks5",
        "socksport": "6667",
        "socksusername": "anonymous",
        "sockspassword": "",
        "bothost": "",
        "botpath": "",
        "localbothost": "0.0.0.0",
        "localbotport": "8443",
        "publicbotport": "8443",
        "privatekey": "",
        "certificate": "",
        "useselfsignedcertificate": false,
        "sslterminated": false,
        "verboselogging": false
    },
    {
        "id": "0a54eaefa4e4f527",
        "type": "telegrambot-config",
        "botname": "mudanssa_bot",
        "usernames": "",
        "chatIds": "-1002546713175",
        "pollInterval": 300
    },
    {
        "id": "0e7b3b71b7f2042f",
        "type": "telegram sender",
        "z": "d0aa877c69268acf",
        "name": "Sender node",
        "bot": "8de2ee7b9a7ab0c8",
        "haserroroutput": true,
        "outputs": 2,
        "x": 1895,
        "y": 620,
        "wires": [
            [
                "34e5b885f1409ad3"
            ],
            [
                "34e5b885f1409ad3"
            ]
        ],
        "l": false
    },
    {
        "id": "a9fe3ae2055693a9",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Combine data",
        "func": "node.warn(\"Meta at Combine Data: \" + JSON.stringify(msg.meta));\nlet apartmentDetails = msg.payload.details || []; // AD data from the Apart Details node\nlet links = msg.payload.links || []; // LE data from the Links Extraction node\n\n// Debug the apartmentDetails and links arrays before combining\nnode.warn(\"Apartment Details: \" + JSON.stringify(apartmentDetails));\nnode.warn(\"Links: \" + JSON.stringify(links));\n\n// Combine the arrays into an array of objects without length checking\nlet combinedData = apartmentDetails.map((detail, index) => ({\n    apartmentDetails: detail,\n    link: links[index] || \"\" // If there's no link, use an empty string\n}));\n\n// Set the combined data to the message payload\nmsg.payload = combinedData;\nmsg.chatId = msg.payload.chatId;  // << This is the key fix\nmsg.meta = msg.meta || {};             // preserve metadata if exists\n\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1010,
        "y": 420,
        "wires": [
            [
                "a78f54db46bd24e0",
                "f24b535175547127"
            ]
        ]
    },
    {
        "id": "c8bf7d979e9a1b34",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "debug TELEMSG",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1530,
        "y": 560,
        "wires": []
    },
    {
        "id": "e70cf8870352a304",
        "type": "inject",
        "z": "d0aa877c69268acf",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"chatId\":\"-1002546713175\",\"type\":\"message\",\"content\":\"I WILL MURDER SILVIA\",\"options\":{\"parse_mode\":\"Markdown\"}}",
        "payloadType": "json",
        "x": 1830,
        "y": 800,
        "wires": [
            [
                "0e7b3b71b7f2042f"
            ]
        ]
    },
    {
        "id": "34e5b885f1409ad3",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "TELEGRAM",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2090,
        "y": 560,
        "wires": []
    },
    {
        "id": "2b5cb2969cbd015f",
        "type": "join",
        "z": "d0aa877c69268acf",
        "name": "",
        "mode": "custom",
        "build": "object",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "useparts": true,
        "accumulate": false,
        "timeout": "",
        "count": "2",
        "reduceRight": false,
        "reduceExp": "",
        "reduceInit": "",
        "reduceInitType": "",
        "reduceFixup": "",
        "x": 830,
        "y": 380,
        "wires": [
            [
                "a9fe3ae2055693a9"
            ]
        ]
    },
    {
        "id": "a78f54db46bd24e0",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "COMBINE",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1100,
        "y": 280,
        "wires": []
    },
    {
        "id": "8df5cd8e199452df",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Assigning payload.links",
        "func": "// Assuming msg.payload contains the extracted links (relative URLs) after the \"Links Extraction\" node\nlet links = msg.payload || []; // Links extracted from the Links Extraction node\n\n// Move the links to msg.payload.links for consistency\nmsg.payload.links = links;\n\nmsg.topic = \"links\"\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 340,
        "wires": [
            [
                "82fe7d310caba5da",
                "2b5cb2969cbd015f"
            ]
        ]
    },
    {
        "id": "b51ae58ec3ecf31b",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Assigning payload.details",
        "func": "// Assuming msg.payload contains the extracted apartment details from the \"Apart Details\" node\nlet details = msg.payload || []; // Details extracted from the Apart Details node\n\n// Move the details to msg.payload.details for consistency\nmsg.payload.details = details;\n\nmsg.topic = \"details\"\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 550,
        "y": 440,
        "wires": [
            [
                "2b5cb2969cbd015f"
            ]
        ]
    },
    {
        "id": "146765422d35e6fe",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Links cleaning",
        "func": "let baseURL = \"https://inberlinwohnen.de\"; // Base URL for relative links\n\n// Retrieve links and details from msg.payload\nlet links = msg.payload || [];  // Links extracted from the links node\n\n// Extract href attribute from each link object and prepend baseURL\nlet extractedLinks = links.map(linkObj => {\n    let href = linkObj.href || \"\";  // Default to empty string if 'href' is not available\n    return baseURL + href;  // Combine baseURL with the href\n});\n\n// Set the final array of full URLs as the message payload\nmsg.payload = extractedLinks;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 340,
        "wires": [
            [
                "f758067ba03a773f",
                "8df5cd8e199452df"
            ]
        ]
    },
    {
        "id": "82fe7d310caba5da",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 890,
        "y": 200,
        "wires": []
    },
    {
        "id": "5aa6e0e3fec00bce",
        "type": "html",
        "z": "d0aa877c69268acf",
        "name": "Apart details",
        "property": "payload",
        "outproperty": "payload",
        "tag": "span._tb_left",
        "ret": "text",
        "as": "single",
        "chr": "",
        "x": 270,
        "y": 440,
        "wires": [
            [
                "645686cd74a65ca2",
                "b51ae58ec3ecf31b"
            ]
        ]
    },
    {
        "id": "ea9ae61a70074cfe",
        "type": "html",
        "z": "d0aa877c69268acf",
        "name": "Links Extraction",
        "property": "payload",
        "outproperty": "payload",
        "tag": "a.org-but",
        "ret": "attr",
        "as": "single",
        "chr": "",
        "x": 280,
        "y": 360,
        "wires": [
            [
                "92e102b999c94c1f",
                "146765422d35e6fe"
            ]
        ]
    },
    {
        "id": "f758067ba03a773f",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "CLEAN LINKS",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 280,
        "wires": []
    },
    {
        "id": "a0e3b01f1caef6e2",
        "type": "http request",
        "z": "d0aa877c69268acf",
        "name": "",
        "method": "GET",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "https://inberlinwohnen.de/wohnungsfinder/",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 270,
        "y": 280,
        "wires": [
            [
                "33aa046a936116c8",
                "ea9ae61a70074cfe",
                "5aa6e0e3fec00bce"
            ]
        ]
    },
    {
        "id": "645686cd74a65ca2",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "DETAILS",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 520,
        "y": 520,
        "wires": []
    },
    {
        "id": "92e102b999c94c1f",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "LINKS",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 530,
        "y": 280,
        "wires": []
    },
    {
        "id": "f5926c4e571266dc",
        "type": "inject",
        "z": "d0aa877c69268acf",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 210,
        "y": 160,
        "wires": [
            [
                "eeac0283ed4a0b73"
            ]
        ]
    },
    {
        "id": "33aa046a936116c8",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "request",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 400,
        "y": 200,
        "wires": []
    },
    {
        "id": "2603995721fca7e7",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Catch empty msgs (no new listings)",
        "func": "const chatId = msg.payload.chatId || (msg.payload.chat && msg.payload.chat.id) || flow.get(\"last_chatId\");\n\n// get user-specific filters\nconst min = flow.get(chatId + \"_minPrice\") || 0;\nconst max = flow.get(chatId + \"_maxPrice\") || Infinity;\n\n// now filter your listings here...\nmsg.payload.chatId = msg.payload.chatId || (msg.payload.chat && msg.payload.chat.id) || flow.get(\"last_chatId\");\n;\n\nif (msg.payload && msg.payload.content === \"❗ No new apartments to send.\") {\n    msg.payload = {\n        chatId: msg.payload.chatId,\n        type: \"message\",\n        content: \"❗ No new listings in the last 5 minutes.\",\n        options: { parse_mode: \"Markdown\" }\n    };\n    return msg;\n}\n\nreturn null;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1540,
        "y": 780,
        "wires": [
            [
                "0e7b3b71b7f2042f"
            ]
        ]
    },
    {
        "id": "6431c94aaab0a426",
        "type": "telegram sender",
        "z": "d0aa877c69268acf",
        "name": "",
        "bot": "8de2ee7b9a7ab0c8",
        "haserroroutput": false,
        "outputs": 1,
        "x": 1310,
        "y": 920,
        "wires": [
            []
        ]
    },
    {
        "id": "welcome_function",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Welcome + Location",
        "func": "\nmsg.payload = {\n    chatId: msg.payload.chatId,\n    type: 'message',\n    content: `👋 Welcome to Mudanssa Bot!\\n\\nTo begin, click the *Location* button below to define in which city Mudanssa should focus its efforts.`,\n    options: {\n        parse_mode: \"Markdown\",\n        reply_markup: {\n            keyboard: [[{ text: \"Berlin\" }, { text: \"Other cities\" }]],\n            resize_keyboard: true,\n            one_time_keyboard: true\n        }\n    }\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 920,
        "wires": [
            [
                "6431c94aaab0a426"
            ]
        ]
    },
    {
        "id": "other_cities_fn",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Notify + Re-prompt Location",
        "func": "const chatId = msg.payload.chatId || (msg.payload.chat && msg.payload.chat.id);\n\nconst notSupportedMsg = {\n    payload: {\n        chatId,\n        type: 'message',\n        content: '❗ Other cities are not supported in the current development stage.',\n        options: {\n            reply_markup: {\n                keyboard: [[{ text: \"Berlin\" }, { text: \"Other cities\" }]],\n                resize_keyboard: true,\n                one_time_keyboard: true\n            }\n        }\n    }\n};\n\nconst rePromptMsg = {\n    payload: {\n        chatId,\n        type: 'message',\n        content: 'Please select your location again.',\n        options: {\n            reply_markup: {\n                keyboard: [[{ text: \"Berlin\" }, { text: \"Other cities\" }]],\n                resize_keyboard: true,\n                one_time_keyboard: true\n            }\n        }\n    }\n};\n\n// Send them to output one by one\nreturn [notSupportedMsg, rePromptMsg];\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 1360,
        "wires": [
            [
                "69c3b80f1114a105",
                "6431c94aaab0a426"
            ],
            [
                "69c3b80f1114a105",
                "6431c94aaab0a426"
            ]
        ]
    },
    {
        "id": "confirm_berlin_function",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Confirm Berlin",
        "func": "const chatId = msg.payload.chatId || (msg.payload.chat && msg.payload.chat.id);\n\nmsg.payload = {\n  chatId,\n  type: \"message\",\n  content: `✅ Berlin selected!\\n\\nLet’s define your budget.`,\n  options: {\n    parse_mode: \"Markdown\",\n    reply_markup: {\n      keyboard: [[\n        { text: \"Start\" }\n      ], [\n        { text: \"Summary\" }, { text: \"Help\" }, { text: \"Reset\" }\n      ]],\n      resize_keyboard: true,\n      one_time_keyboard: false\n    }\n  }\n};\n\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 1300,
        "wires": [
            [
                "ask_min_price",
                "56630607e7c76841"
            ]
        ]
    },
    {
        "id": "ask_min_price",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Ask Min Price",
        "func": "// Save state\nconst chatId = msg.payload.chatId || (msg.payload.chat && msg.payload.chat.id);\nflow.set(chatId + '_awaiting', 'min');\n\nmsg.payload = {\n  chatId,\n  type: 'message',\n  content: '💬 What is your *minimum price* in €?',\n  options: { parse_mode: \"Markdown\" }\n};\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 840,
        "y": 1300,
        "wires": [
            [
                "90cfdbd6721d025e"
            ]
        ]
    },
    {
        "id": "catch_message",
        "type": "telegram receiver",
        "z": "d0aa877c69268acf",
        "name": "Catch Text Responses",
        "bot": "8de2ee7b9a7ab0c8",
        "saveDataDir": "",
        "filterCommands": false,
        "x": 100,
        "y": 900,
        "wires": [
            [
                "f3076787fab18a68",
                "f3709a0efdf9db35"
            ],
            [
                "f3076787fab18a68",
                "f3709a0efdf9db35"
            ]
        ]
    },
    {
        "id": "handle_price_input",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Handle Price Input",
        "func": "const chatId = msg.payload.chatId || (msg.payload.chat && msg.payload.chat.id);\nconst content = msg.payload.content?.trim();\nconst state = flow.get(chatId + '_awaiting');\n\nlet allChats = flow.get(\"allChatIds\") || [];\nif (!allChats.includes(chatId)) {\n    allChats.push(chatId);\n    flow.set(\"allChatIds\", allChats);\n}\n\n\n// 🛑 If no state is set, ignore the message completely\nif (!state) {\n    return [null, null];\n}\n\n// Basic validation: check if content is a number\nconst userInput = parseInt(content, 10);\nif (isNaN(userInput)) {\n    return [{\n        payload: {\n            chatId,\n            type: 'message',\n            content: \"❗ Please enter a valid number (e.g., 400).\"\n        }\n    }, null];\n}\n\nif (state === 'min') {\n    flow.set(chatId + '_minPrice', userInput);\n    flow.set(chatId + '_awaiting', 'max');\n\n    return [{\n        payload: {\n            chatId,\n            type: 'message',\n            content: '💬 Now, what is your *maximum price* in €?',\n            options: { parse_mode: \"Markdown\" }\n        }\n    }, null];\n\n} else if (state === 'max') {\n    flow.set(chatId + '_maxPrice', userInput);\n    flow.set(chatId + '_awaiting', null);\n\n    const confirmationMsg = {\n        payload: {\n            chatId,\n            type: 'message',\n            content: `✅ Your preferences have been saved!\\nWe'll start sending you personalized apartment listings shortly.`,\n            options: { parse_mode: \"Markdown\" }\n        }\n    };\n\n    const logTriggerMsg = {\n        payload: {\n            chatId,\n            meta: { initialRequest: true }\n        }\n    };\n\n    return [confirmationMsg, logTriggerMsg];\n}\n\nreturn [null, null];\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 1100,
        "wires": [
            [
                "90cfdbd6721d025e"
            ],
            [
                "8df19b0c68bf3d3e",
                "03fc6e792c829ef4",
                "eeac0283ed4a0b73"
            ]
        ]
    },
    {
        "id": "2593a308174a5cce",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Clear State/Start over",
        "func": "const chatId = msg.payload.chatId || (msg.payload.chat && msg.payload.chat.id);\n\n// ✅ Clear user-specific flow data\nflow.set(chatId + \"_minPrice\", null);\nflow.set(chatId + \"_maxPrice\", null);\nflow.set(chatId + \"_awaiting\", null);\nflow.set(chatId + \"_seen\", []); // ✅ Should be here\n\n// ✅ Trigger a reset listing request\nreturn {\n    payload: {\n        chatId: chatId,\n        meta: { initialRequest: true }  // mark this as initial\n    }\n};\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 980,
        "wires": [
            [
                "welcome_function"
            ]
        ]
    },
    {
        "id": "8df19b0c68bf3d3e",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Prepare user log",
        "func": "const chatId = msg.payload.chatId;\nconst min = flow.get(chatId + \"_minPrice\");\nconst max = flow.get(chatId + \"_maxPrice\");\n\nmsg.filename = `/home/alex/UE-Germany/Agile_Project_2ndSemester/HomeSearch_Node-Red/user_${chatId}.json`;\nmsg.payload = JSON.stringify({\n  chatId,\n  location: \"Berlin\",\n  minPrice: min,\n  maxPrice: max,\n  timestamp: new Date().toISOString()\n}) + \"\\n\";\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 840,
        "y": 1100,
        "wires": [
            [
                "1e11f260d97cb415"
            ]
        ]
    },
    {
        "id": "1e11f260d97cb415",
        "type": "file",
        "z": "d0aa877c69268acf",
        "name": "",
        "filename": "filename",
        "filenameType": "msg",
        "appendNewline": false,
        "createDir": false,
        "overwriteFile": "false",
        "encoding": "none",
        "x": 1020,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "d9798681e5410684",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Summary generator",
        "func": "const chatId = msg.payload.chatId || (msg.payload.chat && msg.payload.chat.id);\nconst min = flow.get(chatId + '_minPrice') || 'not set';\nconst max = flow.get(chatId + '_maxPrice') || 'not set';\n\nmsg.payload = {\n    chatId: chatId,\n    type: 'message',\n    content: `📋 *Your Selections:*\\n- Location: *Berlin*\\n- Min: *€${min}*\\n- Max: *€${max}*`,\n    options: {\n        parse_mode: \"Markdown\"\n    }\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 1060,
        "wires": [
            [
                "90cfdbd6721d025e"
            ]
        ]
    },
    {
        "id": "03fc6e792c829ef4",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 1160,
        "wires": []
    },
    {
        "id": "4148628eb669f181",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 740,
        "y": 1220,
        "wires": []
    },
    {
        "id": "f3076787fab18a68",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "debug 4",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 340,
        "y": 820,
        "wires": []
    },
    {
        "id": "eeac0283ed4a0b73",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "ChatID Set",
        "func": "msg.chatId = msg.payload.chatId || (msg.payload.chat && msg.payload.chat.id);\n\nmsg.meta = msg.meta || msg.payload.meta || {};  // ✅ Keep this line\nnode.warn(\"Meta after ChatID set: \" + JSON.stringify(msg.meta));\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 250,
        "y": 560,
        "wires": [
            [
                "a0e3b01f1caef6e2"
            ]
        ]
    },
    {
        "id": "ea07c407f15f7d8a",
        "type": "switch",
        "z": "d0aa877c69268acf",
        "name": "Handle User Commands",
        "property": "msg.normalized",
        "propertyType": "jsonata",
        "rules": [
            {
                "t": "eq",
                "v": "start",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "reset",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "help",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "summary",
                "vt": "str"
            },
            {
                "t": "else"
            },
            {
                "t": "eq",
                "v": "berlin",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "other cities",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 7,
        "x": 350,
        "y": 1100,
        "wires": [
            [
                "welcome_function",
                "eeac0283ed4a0b73"
            ],
            [
                "2593a308174a5cce"
            ],
            [
                "5999e5cebc53d3ad"
            ],
            [
                "d9798681e5410684"
            ],
            [
                "handle_price_input"
            ],
            [
                "confirm_berlin_function",
                "4148628eb669f181"
            ],
            [
                "other_cities_fn",
                "4148628eb669f181"
            ]
        ]
    },
    {
        "id": "f3709a0efdf9db35",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "normalize command",
        "func": "msg.normalized = msg.payload.content.toLowerCase().replace(\"/\", \"\").trim();\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 980,
        "wires": [
            [
                "ea07c407f15f7d8a",
                "541ad82557d2f73e"
            ]
        ]
    },
    {
        "id": "541ad82557d2f73e",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "debug 5",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 340,
        "y": 900,
        "wires": []
    },
    {
        "id": "5999e5cebc53d3ad",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Show help",
        "func": "const chatId = msg.payload.chatId || (msg.payload.chat && msg.payload.chat.id);\nmsg.payload = {\n  chatId: chatId,\n  type: \"message\",\n  content: \"🆘 *How to use Mudanssa Bot:*\\n\\n1. Press **Start** to begin\\n2. Choose **Berlin** as your location\\n3. Enter your price range\\n4. Use:\\n- `Reset` to start over\\n- `Summary` to see your settings\\n- `Help` to read this again\",\n  options: {\n    parse_mode: \"Markdown\"\n  }\n};\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 1020,
        "wires": [
            [
                "90cfdbd6721d025e"
            ]
        ]
    },
    {
        "id": "56630607e7c76841",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "debug 6",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1020,
        "y": 1380,
        "wires": []
    },
    {
        "id": "90cfdbd6721d025e",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "custom Keyboard attachment",
        "func": "if (!msg || !msg.payload || !msg.payload.chatId) {\n    return null;  // Skip processing if msg or chatId is missing\n}\n\nconst chatId = msg.payload.chatId;\n\n// Append keyboard to every outgoing message\nmsg.payload.options = msg.payload.options || {};\nmsg.payload.options.reply_markup = {\n    keyboard: [\n        [{ text: \"Start\" }, { text: \"Summary\" }],\n        [{ text: \"Reset\" }, { text: \"Help\" }]\n    ],\n    resize_keyboard: true,\n    one_time_keyboard: false\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1120,
        "y": 1200,
        "wires": [
            [
                "6431c94aaab0a426",
                "45462d065a0cd7f0"
            ]
        ]
    },
    {
        "id": "53ba90a73bf3d505",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "PRICE FILTER",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1340,
        "y": 400,
        "wires": []
    },
    {
        "id": "647ca9a950064270",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Filter by price V2",
        "func": "const chatId = msg.chatId;\nconst min = flow.get(chatId + \"_minPrice\");\nconst max = flow.get(chatId + \"_maxPrice\");\n\nlet isInitial = msg.meta?.initialRequest === true || msg.payload?.meta?.initialRequest === true;\n\nconst seenLinks = flow.get(chatId + \"_seen\") || [];\nconst inRange = [];\n\nfor (let item of msg.payload) {\n    const detail = item.apartmentDetails || \"\";\n    const link = item.link || item.url || \"\";\n\n    const priceMatch = detail.match(/([\\d.]+,\\d+)\\s*€/);\n    if (!priceMatch) continue;\n\n    const priceStr = priceMatch[1].replace('.', '').replace(',', '.');\n    const price = parseFloat(priceStr);\n\n    if (price >= min && price <= max) {\n        inRange.push({ apartmentDetails: detail, link });\n    }\n}\n\nlet toSend = [];\nif (isInitial) {\n    toSend = inRange.slice(-10);\n} else {\n    const seen = new Set(seenLinks);\n    toSend = inRange.filter(o => !seen.has(o.link));\n    const newSeen = [...new Set([...seenLinks, ...toSend.map(o => o.link)])];\n    flow.set(chatId + \"_seen\", newSeen);\n}\n\nnode.warn(`Initial: ${isInitial}, Min: ${min}, Max: ${max}, Found: ${inRange.length}, Sending: ${toSend.length}`);\nmsg.payload = toSend;\nmsg.chatId = chatId;\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 520,
        "wires": [
            [
                "53ba90a73bf3d505",
                "be1eb5b0c123d921"
            ]
        ]
    },
    {
        "id": "63dc038b777e74f8",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "filter by price v3",
        "func": "const chatId = msg.chatId;\nconst min = msg.min;\nconst max = msg.max;\nlet isInitial = msg.meta?.initialRequest === true;\n\nconst seenLinks = msg.seen || [];\nconst inRange = [];\n\nfor (let item of msg.payload) {\n    const detail = item.apartmentDetails || \"\";\n    const link = item.link || item.url || \"\";\n\n    const priceMatch = detail.match(/([\\d.]+,\\d+)\\s*€/);\n    if (!priceMatch) continue;\n\n    const priceStr = priceMatch[1].replace('.', '').replace(',', '.');\n    const price = parseFloat(priceStr);\n\n    if (price >= min && price <= max) {\n        inRange.push({ apartmentDetails: detail, link });\n    }\n}\n\nlet toSend = isInitial ? inRange.slice(-10) : inRange.filter(o => !seenLinks.includes(o.link));\nlet newSeen = [...new Set([...seenLinks, ...toSend.map(o => o.link)])];\nflow.set(chatId + \"_seen\", newSeen);\n\nnode.warn(`Min: ${min}, Max: ${max}, Found: ${inRange.length} in range. Sending ${toSend.length}.`);\n\nmsg.payload = toSend;\nmsg.chatId = chatId;\nmsg.meta = msg.meta;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 580,
        "wires": [
            [
                "ddb9eab9cd7bcf20"
            ]
        ]
    },
    {
        "id": "a7fbc8d21b1b4b77",
        "type": "split",
        "z": "d0aa877c69268acf",
        "name": "Split formatted array",
        "splt": "",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 1460,
        "y": 700,
        "wires": [
            [
                "0e7b3b71b7f2042f",
                "2603995721fca7e7",
                "c8bf7d979e9a1b34"
            ]
        ]
    },
    {
        "id": "91a0684346ff1fe0",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "debug 7",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1310,
        "y": 540,
        "wires": []
    },
    {
        "id": "ddb9eab9cd7bcf20",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Format Telegram Msg V2",
        "func": "const chatId = msg.chatId;\nconst min = msg.min;\nconst max = msg.max;\nlet isInitial = msg.meta?.initialRequest === true;\n\nconst seenLinks = msg.seen || [];\nconst inRange = [];\n\nfor (let item of msg.payload) {\n    const detail = item.apartmentDetails || \"\";\n    const link = item.link || item.url || \"\";\n\n    const priceMatch = detail.match(/([\\d.]+,\\d+)\\s*€/);\n    if (!priceMatch) continue;\n\n    const priceStr = priceMatch[1].replace('.', '').replace(',', '.');\n    const price = parseFloat(priceStr);\n\n    if (price >= min && price <= max) {\n        inRange.push({ apartmentDetails: detail, link });\n    }\n}\n\nlet toSend = isInitial ? inRange.slice(-10) : inRange.filter(o => !seenLinks.includes(o.link));\nlet newSeen = [...new Set([...seenLinks, ...toSend.map(o => o.link)])];\nflow.set(chatId + \"_seen\", newSeen);\n\nnode.warn(`Min: ${min}, Max: ${max}, Found: ${inRange.length} in range. Sending ${toSend.length}.`);\n\nmsg.payload = toSend;\nmsg.chatId = chatId;\nmsg.meta = msg.meta;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 650,
        "y": 640,
        "wires": [
            []
        ]
    },
    {
        "id": "69c3b80f1114a105",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "REPROMPT",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1100,
        "y": 1520,
        "wires": []
    },
    {
        "id": "45462d065a0cd7f0",
        "type": "debug",
        "z": "d0aa877c69268acf",
        "name": "keyboard",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1210,
        "y": 1300,
        "wires": []
    },
    {
        "id": "f24b535175547127",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "iterate users",
        "func": "let allChats = flow.get(\"allChatIds\") || [];\nlet outputs = [];\n\nlet isInitial = msg.meta?.initialRequest === true;\n\nfor (let chatId of allChats) {\n    let min = flow.get(chatId + \"_minPrice\") || 0;\n    let max = flow.get(chatId + \"_maxPrice\") || Infinity;\n    let seen = flow.get(chatId + \"_seen\") || [];\n\n    outputs.push({\n        payload: msg.payload,  // entire listings data\n        chatId,\n        meta: {\n            initialRequest: isInitial,\n            min,\n            max,\n            seen\n        }\n    });\n}\n\nreturn [outputs];\n\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 520,
        "wires": [
            [
                "647ca9a950064270"
            ]
        ]
    },
    {
        "id": "be1eb5b0c123d921",
        "type": "function",
        "z": "d0aa877c69268acf",
        "name": "Format Telegram Msg V3",
        "func": "const chatId = msg.chatId || msg.payload.chatId || flow.get(\"last_chatId\");\nflow.set(\"last_chatId\", chatId);\n\n// Get the seen links passed from previous node\nconst seen = new Set(msg.meta?.seen || []);\n\nlet formattedMessages = [];\nlet newSeen = [];\n\nmsg.payload.forEach(apartment => {\n    const detail = apartment.apartmentDetails;\n    const link = apartment.link;\n\n    if (!seen.has(link)) {\n        newSeen.push(link);\n\n        let parts = detail.split('|');\n        let address = parts.length > 1 ? parts[1].trim() : \"Unknown location\";\n        let mapsLink = `https://www.google.com/maps?q=${encodeURIComponent(address)}`;\n\n        formattedMessages.push({\n            chatId: chatId,\n            type: \"message\",\n            content: `🏠 *Apartment Details:* ${detail}\\n\\n🔗 [More Info](${link})\\n🗺️ [Google Maps](${mapsLink})`,\n            options: { parse_mode: \"Markdown\" }\n        });\n    }\n});\n\nif (formattedMessages.length > 0) {\n    msg.payload = formattedMessages;\n} else {\n    msg.payload = [{\n        chatId: chatId,\n        type: \"message\",\n        content: \"❗ No new apartments to send.\"\n    }];\n}\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1090,
        "y": 640,
        "wires": [
            [
                "a7fbc8d21b1b4b77",
                "91a0684346ff1fe0"
            ]
        ]
    }
]